name: Build and Deploy Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, staging, prod]
        default: prod
        description: "Ambiente para deploy"

env:
  REGISTRY_HOST: registry.digitalocean.com
  IMAGE_REPO: fishing-map-prod/migrations
  K8S_NAMESPACE: fishing-map
  K8S_CLUSTER_NAME: fishing-map-prod-cluster

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'prod' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build TypeScript
        run: pnpm run build

      - name: Set IMAGE tag (commit SHA)
        run: |
          TAG=${{ github.sha }}
          IMAGE_FULL=${{ env.REGISTRY_HOST }}/${{ env.IMAGE_REPO }}:${TAG}
          echo "IMAGE_TAG=${TAG}" >> $GITHUB_ENV
          echo "IMAGE_FULL=${IMAGE_FULL}" >> $GITHUB_ENV
          echo "IMAGE_FULL=${IMAGE_FULL}"

      - name: Build Docker Image
        run: |
          echo "Building Docker image $IMAGE_FULL"
          docker build -t $IMAGE_FULL .
          docker tag $IMAGE_FULL ${{ env.REGISTRY_HOST }}/${{ env.IMAGE_REPO }}:latest
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Push Docker Image
        run: |
          echo "Pushing image $IMAGE_FULL"
          docker push $IMAGE_FULL
          docker push ${{ env.REGISTRY_HOST }}/${{ env.IMAGE_REPO }}:latest
          echo "Pushed: $IMAGE_FULL"

      - name: Configure kubectl
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.K8S_CLUSTER_NAME }}
          kubectl get nodes || true

      - name: Ensure namespace exists
        run: |
          kubectl get namespace ${{ env.K8S_NAMESPACE }} || kubectl create namespace ${{ env.K8S_NAMESPACE }}

      - name: Create/Update registry secret
        run: |
          mkdir -p /tmp/.docker
          if [ -f "$HOME/.docker/config.json" ]; then
            cp "$HOME/.docker/config.json" /tmp/.docker/config.json
          elif [ -f "/github/home/.docker/config.json" ]; then
            cp "/github/home/.docker/config.json" /tmp/.docker/config.json
          else
            echo "ERRO: docker config.json não encontrado."
            exit 1
          fi

          kubectl delete secret registry-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          kubectl create secret generic registry-secret \
            --from-file=.dockerconfigjson=/tmp/.docker/config.json \
            --type=kubernetes.io/dockerconfigjson \
            -n ${{ env.K8S_NAMESPACE }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Delete previous migrations job (if exists)
        run: |
          echo "Deletando job anterior se existir..."
          kubectl delete job db-migrations -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          echo "Aguardando pods serem removidos..."
          sleep 5

      - name: Deploy migrations with Helm
        run: |
          echo "Deploying migrations with Helm..."
          helm upgrade --install db-migrations ./helm \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --set image.tag=${{ github.sha }} \
            --set image.repository=${{ env.REGISTRY_HOST }}/${{ env.IMAGE_REPO }} \
            --wait \
            --timeout 5m

      - name: Wait for Job completion and show logs
        run: |
          set -o pipefail
          echo "Aguardando job/db-migrations completar (timeout 300s)..."
          if ! kubectl wait --for=condition=complete --timeout=300s job/db-migrations -n ${{ env.K8S_NAMESPACE }}; then
            echo "Migrations job falhou ou timeout. Dumping info para debug..."
            echo "=== JOBs ==="
            kubectl get jobs -n ${{ env.K8S_NAMESPACE }} -o wide || true
            echo "=== PODs ==="
            kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app.kubernetes.io/name=fishing-map-migrations -o wide || true
            echo "=== LAST 200 LINES LOGS ==="
            kubectl logs -l app.kubernetes.io/name=fishing-map-migrations -n ${{ env.K8S_NAMESPACE }} --tail=200 || true
            echo "=== DESCRIBE PODS ==="
            kubectl describe pod -l app.kubernetes.io/name=fishing-map-migrations -n ${{ env.K8S_NAMESPACE }} | head -240 || true
            exit 1
          fi
          echo "Job concluído com sucesso. Exibindo logs completos:"
          kubectl logs -l app.kubernetes.io/name=fishing-map-migrations -n ${{ env.K8S_NAMESPACE }} || true

      - name: Verify deployment
        run: |
          echo "=== Helm Release ==="
          helm list -n ${{ env.K8S_NAMESPACE }} | grep migrations || true
          echo ""
          echo "=== Jobs ==="
          kubectl get jobs -n ${{ env.K8S_NAMESPACE }} | grep migrations || true
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app.kubernetes.io/name=fishing-map-migrations || true

      - name: Summary
        if: success()
        run: |
          echo "## Deploy Completo!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Imagem Publicada:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY_HOST }}/${{ env.IMAGE_REPO }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Migrations:" >> $GITHUB_STEP_SUMMARY
          echo "- Helm release: \`db-migrations\`" >> $GITHUB_STEP_SUMMARY
          echo "- Namespace: \`${{ env.K8S_NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Container Registry](https://cloud.digitalocean.com/registry)" >> $GITHUB_STEP_SUMMARY
          echo "- [Kubernetes Clusters](https://cloud.digitalocean.com/kubernetes/clusters)" >> $GITHUB_STEP_SUMMARY

