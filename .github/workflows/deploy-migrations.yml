name: Build and Deploy Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, staging, prod]
        default: prod
        description: "Ambiente para deploy"
      run_migrations:
        type: boolean
        default: true
        description: "Executar migrations após deploy?"

env:
  REGISTRY_HOST: registry.digitalocean.com
  IMAGE_REPO: fishing-map-prod/migrations
  K8S_NAMESPACE: fishing-map
  K8S_CLUSTER_NAME: fishing-map-prod-cluster

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'prod' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build TypeScript
        run: pnpm run build

      - name: Set IMAGE tag (commit SHA)
        run: |
          TAG=${{ github.sha }}
          IMAGE_FULL=${{ env.REGISTRY_HOST }}/$IMAGE_REPO:${TAG}
          echo "IMAGE_TAG=${TAG}" >> $GITHUB_ENV
          echo "IMAGE_FULL=${IMAGE_FULL}" >> $GITHUB_ENV
          echo "IMAGE_FULL=${IMAGE_FULL}"

      - name: Build Docker Image
        run: |
          echo "Building Docker image $IMAGE_FULL"
          docker build -t $IMAGE_FULL .
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}"

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: |
          # this will write docker config under runner's home (~/.docker/config.json)
          doctl registry login --expiry-seconds 600

      - name: Push Docker Image
        run: |
          echo "Pushing image $IMAGE_FULL"
          docker push $IMAGE_FULL
          echo "Pushed: $IMAGE_FULL"

      - name: Configure kubectl (doctl kubeconfig)
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.K8S_CLUSTER_NAME }}
          kubectl get nodes || true

      - name: Create/Update registry secret (dockerconfigjson)
        run: |
          # copia dockerconfig para criar secret do tipo dockerconfigjson no k8s
          mkdir -p /tmp/.docker
          # the runner docker config is usually in /github/home/.docker/config.json or ~/.docker/config.json
          if [ -f "$HOME/.docker/config.json" ]; then
            cp "$HOME/.docker/config.json" /tmp/.docker/config.json
          elif [ -f "/github/home/.docker/config.json" ]; then
            cp "/github/home/.docker/config.json" /tmp/.docker/config.json
          else
            echo "ERRO: docker config.json não encontrado. Assegure doctl registry login executado."
            ls -la $HOME/.docker || true
            exit 1
          fi

          kubectl get namespace ${{ env.K8S_NAMESPACE }} || kubectl create namespace ${{ env.K8S_NAMESPACE }}
          kubectl delete secret registry-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          kubectl create secret generic registry-secret \
            --from-file=.dockerconfigjson=/tmp/.docker/config.json \
            --type=kubernetes.io/dockerconfigjson \
            -n ${{ env.K8S_NAMESPACE }}

      - name: Create/Update DB credentials secret
        run: |
          kubectl delete secret fishing-map-secrets -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          kubectl create secret generic fishing-map-secrets \
            --from-literal=DB_HOST=${{ secrets.DB_HOST }} \
            --from-literal=DB_PORT=${{ secrets.DB_PORT }} \
            --from-literal=DB_NAME=${{ secrets.DB_NAME }} \
            --from-literal=DB_USER=${{ secrets.DB_USER }} \
            --from-literal=DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -n ${{ env.K8S_NAMESPACE }}

      - name: Backup migrations manifest (optional)
        run: |
          cp k8s/migrations-job.yaml k8s/migrations-job.yaml.bak || true

      - name: Replace image in k8s/migrations-job.yaml with SHA-tagged image
        run: |
          # Replace the image line for migrations; this sed assumes there is a single image line for the migrations container.
          if grep -q "image:" k8s/migrations-job.yaml; then
            echo "Substituindo image no manifest por: $IMAGE_FULL"
            # Two-step sed: replace exact registry path with IMAGE_FULL, fallback replace generic image: line
            sed -i "s|registry.digitalocean.com/fishing-map-prod/migrations:.*|$IMAGE_FULL|g" k8s/migrations-job.yaml || true
            sed -i "0,/image:/{s|image:.*|image: $IMAGE_FULL|}" k8s/migrations-job.yaml || true
            echo "Resultado:"
            grep -n "image:" k8s/migrations-job.yaml || true
          else
            echo "AVISO: k8s/migrations-job.yaml não contém 'image:'"
            exit 1
          fi

      - name: Apply migrations Job to Kubernetes
        run: |
          # Delete existing Job if it exists (Jobs are immutable in Kubernetes)
          kubectl delete job db-migrations -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          # Apply the new Job
          kubectl apply -f k8s/migrations-job.yaml -n ${{ env.K8S_NAMESPACE }}

      - name: Wait for Job completion and show logs
        run: |
          set -o pipefail
          echo "Aguardando job/db-migrations completar (timeout 300s)..."
          if ! kubectl wait --for=condition=complete --timeout=300s job/db-migrations -n ${{ env.K8S_NAMESPACE }}; then
            echo "Migrations job falhou ou timeout. Dumping info para debug..."
            echo "=== JOBs ==="
            kubectl get jobs -n ${{ env.K8S_NAMESPACE }} -o wide || true
            echo "=== PODs ==="
            kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=migrations -o wide || true
            echo "=== LAST 200 LINES LOGS ==="
            kubectl logs -l app=migrations -n ${{ env.K8S_NAMESPACE }} --tail=200 || true
            echo "=== DESCRIBE PODS ==="
            kubectl describe pod -l app=migrations -n ${{ env.K8S_NAMESPACE }} | sed -n '1,240p' || true
            exit 1
          fi
          echo "Job concluído com sucesso. Exibindo logs completos:"
          kubectl logs -l app=migrations -n ${{ env.K8S_NAMESPACE }} || true

      - name: Verify Jobs and Pods (summary)
        run: |
          echo "Últimos jobs com label app=migrations:"
          kubectl get jobs -n ${{ env.K8S_NAMESPACE }} -l app=migrations --sort-by=.metadata.creationTimestamp | tail -n 10 || true
          echo "Pods relacionados:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=migrations --sort-by=.metadata.creationTimestamp | tail -n 10 || true

      - name: Cleanup backup manifest (optional)
        if: always()
        run: |
          # restore backup if you want to keep repository manifest untouched in case of sed replacement (optional)
          if [ -f k8s/migrations-job.yaml.bak ]; then
            mv k8s/migrations-job.yaml.bak k8s/migrations-job.yaml || true
          fi

      - name: Summary
        if: success()
        run: |
          echo "## Deploy Completo!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Imagem Publicada:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY_HOST }}/${{ env.IMAGE_REPO }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Migrations:" >> $GITHUB_STEP_SUMMARY
          echo "Job db-migrations aplicado no namespace \`${{ env.K8S_NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Container Registry](https://cloud.digitalocean.com/registry)" >> $GITHUB_STEP_SUMMARY
          echo "- [Kubernetes Clusters](https://cloud.digitalocean.com/kubernetes/clusters)" >> $GITHUB_STEP_SUMMARY
