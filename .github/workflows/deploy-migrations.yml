name: Build and Deploy Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, staging, prod]
        default: prod
        description: "Ambiente para deploy"
      run_migrations:
        type: boolean
        default: true
        description: "Executar migrations após deploy?"

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: fishing-map-prod/migrations

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'prod' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build TypeScript
        run: pnpm run build

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login

      - name: Build Docker Image
        run: |
          echo "Buildando imagem Docker..."
          
          # Build da imagem com tag latest
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
          
          echo ""
          echo "Imagem buildada:"
          echo " - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

      - name: Push Docker Images
        run: |
          echo "Enviando imagens para registry..."
          
          # Push apenas da tag latest (outras são redundantes)
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          echo ""
          echo "Imagem publicada:"
          echo " - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "Tags alternativas (mesmo conteudo):"
          echo " - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo " - ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"

      - name: Setup Kubernetes
        run: |
          # Configurar kubectl
          doctl kubernetes cluster kubeconfig save fishing-map-prod-cluster
          
          # Verificar conexão
          kubectl get nodes
          
          # Verificar se namespace existe
          kubectl get namespace fishing-map || kubectl create namespace fishing-map
          
          # Verificar registry secret
          echo "Verificando registry secret..."
          kubectl get secret registry-secret -n fishing-map || {
            echo "Registry secret não encontrado, criando..."
            kubectl create secret docker-registry registry-secret \
              --docker-server=${{ env.REGISTRY }} \
              --docker-username=${{ secrets.DIGITALOCEAN_TOKEN }} \
              --docker-password=${{ secrets.DIGITALOCEAN_TOKEN }} \
              -n fishing-map
          }
          
          # Atualizar registry secret (força refresh)
          kubectl delete secret registry-secret -n fishing-map --ignore-not-found=true
          kubectl create secret docker-registry registry-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ secrets.DIGITALOCEAN_TOKEN }} \
            --docker-password=${{ secrets.DIGITALOCEAN_TOKEN }} \
            -n fishing-map
          
          echo "✅ Registry secret configurado"

      - name: Cleanup Old Resources
        run: |
          echo "Limpando recursos antigos..."
          
          # Deletar todos os jobs de migrations antigos
          echo "Deletando jobs antigos..."
          kubectl delete jobs -n fishing-map -l app=migrations --ignore-not-found=true
          
          # Deletar pods órfãos ou com erro
          echo "Deletando pods com erro..."
          kubectl delete pods -n fishing-map -l app=migrations --field-selector=status.phase=Failed --ignore-not-found=true
          kubectl delete pods -n fishing-map -l app=migrations --field-selector=status.phase=Unknown --ignore-not-found=true
          
          # Aguardar limpeza
          sleep 2
          
          echo "Recursos antigos limpos"

      - name: Deploy Migrations Job
        run: |
          echo "Deployando novo Job de migrations..."
          
          # Aplicar novo job
          kubectl apply -f k8s/migrations-job.yaml
          
          echo ""
          echo "Aguardando pod iniciar..."
          sleep 3
          
          # Mostrar status em tempo real
          echo "Status do job:"
          kubectl get job db-migrations -n fishing-map
          
          echo ""
          echo "Status dos pods:"
          kubectl get pods -n fishing-map -l app=migrations
          
          echo ""
          echo "Aguardando conclusão (timeout: 5min)..."
          echo "Acompanhe os logs em tempo real em outra aba:"
          echo " kubectl logs -f -l app=migrations -n fishing-map"
          echo ""
          
          # Aguardar com timeout reduzido (5min ao invés de 10min)
          kubectl wait --for=condition=complete --timeout=300s job/db-migrations -n fishing-map || {
            echo ""
            echo "Migrations falharam ou timeout!"
            echo ""
            echo "Status final do job:"
            kubectl get job db-migrations -n fishing-map
            echo ""
            echo "Status final dos pods:"
            kubectl get pods -n fishing-map -l app=migrations
            echo ""
            echo "Últimos 100 linhas dos logs:"
            kubectl logs -l app=migrations -n fishing-map --tail=100
            echo ""
            echo "Eventos do pod:"
            kubectl describe pod -l app=migrations -n fishing-map | grep -A 20 Events:
            exit 1
          }
          
          echo ""
          echo "Migrations executadas com sucesso!"
          echo ""
          echo "Logs completos:"
          kubectl logs -l app=migrations -n fishing-map

      - name: Verify Migrations
        run: |
          echo "Verificando migrations executadas..."
          
          # Listar últimos jobs de migrations
          echo "Últimos jobs de migrations:"
          kubectl get jobs -n fishing-map -l app=migrations --sort-by=.metadata.creationTimestamp | tail -5
          
          echo ""
          echo "Status dos pods:"
          kubectl get pods -n fishing-map -l app=migrations --sort-by=.metadata.creationTimestamp | tail -5

      - name: Cleanup Old Images
        run: |
          echo "Limpando imagens antigas..."
          
          # Lista todas as tags da imagem
          doctl registry repository list-tags ${{ env.IMAGE_NAME }} --format Tag,UpdatedAt | head -20
          
          echo "Mantenha apenas as últimas 10 versões manualmente via:"
          echo "  doctl registry repository delete-tag ${{ env.IMAGE_NAME }} <tag>"

      - name: Summary
        run: |
          echo "## Deploy Completo!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Imagem Publicada:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Migrations:" >> $GITHUB_STEP_SUMMARY
          echo "Verifique os logs acima para detalhes das migrations executadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Container Registry](https://cloud.digitalocean.com/registry)" >> $GITHUB_STEP_SUMMARY
          echo "- [Kubernetes](https://cloud.digitalocean.com/kubernetes/clusters)" >> $GITHUB_STEP_SUMMARY
