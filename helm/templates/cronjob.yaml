{{- if .Values.cronjob.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "fishing-map-migrations.fullname" . }}-check
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "fishing-map-migrations.labels" . | nindent 4 }}
    component: periodic-check
spec:
  schedule: {{ .Values.cronjob.schedule | quote }}
  suspend: {{ .Values.cronjob.suspend }}
  successfulJobsHistoryLimit: {{ .Values.cronjob.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.cronjob.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 1800
      template:
        metadata:
          labels:
            {{- include "fishing-map-migrations.selectorLabels" . | nindent 12 }}
            component: periodic-check
        spec:
          restartPolicy: OnFailure

          {{- if .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml .Values.imagePullSecrets | nindent 12 }}
          {{- end }}

          containers:
            - name: migrations-check
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default "latest" }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}

              {{- if .Values.env }}
              env:
                {{- range $key, $value := .Values.env }}
                - name: {{ $key }}
                  value: {{ $value | quote }}
                {{- end }}
              {{- end }}

              {{- if .Values.envFromSecret.enabled }}
              envFrom:
                - secretRef:
                    name: {{ .Values.envFromSecret.secretName }}
              {{- end }}

              command:
                - sh
                - -c
                - |
                  set -e
                  echo "Verificando migrations pendentes..."
                  node dist/run-migrations.js --check || node dist/run-migrations.js
                  echo "Verificação concluída!"

              resources:
                requests:
                  memory: "128Mi"
                  cpu: "50m"
                limits:
                  memory: "256Mi"
                  cpu: "100m"
{{- end }}

